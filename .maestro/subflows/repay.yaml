appId: ${APP_ID ?? "app.exactly"}
---
- waitForAnimationToEnd
- runFlow: { file: scrollTo.yaml, env: { element: Repay } }
- copyTextFrom:
    text: \$[\d,.\xa0]+
    below: Upcoming payments
- evalScript: ${output.debt = Number(maestro.copiedText.replace(/[^\d.]/g, ""))}
- copyTextFrom:
    text: "[^%.$]+"
    below: Upcoming payments
    leftOf: "${maestro.copiedText}"
- evalScript: ${output.maturity = maestro.copiedText}
- tapOn:
    text: "${output.maturity}"
    below: Upcoming payments
- waitForAnimationToEnd
- tapOn: { text: Pay, leftOf: Rollover }
- waitForAnimationToEnd
- runFlow: { when: { true: "${!amount}" }, commands: [{ tapOn: Max }] }
- runFlow:
    when: { true: "${amount}" }
    commands:
      - runFlow:
          when: { platform: android }
          file: ../subflows/longPressAria.yaml
          env: { aria: Repay amount }
      - runFlow:
          when: { true: "${maestro.platform != 'android'}" }
          file: ../subflows/tapAria.yaml
          env: { aria: Repay amount }
      - eraseText
      - inputText: ${amount}
      - tapOn: Subtotal # HACK
- waitForAnimationToEnd
- tapOn: Confirm payment
- assertVisible: Processing.*
- tapOn: Close
- runScript: ../dist/getAccount.js
- runScript:
    file: ../dist/hookProposals.js
    env: { account: "${output.account}" }
- tapOn: Home
- runFlow:
    file: ../subflows/tapWhileAria.yaml
    env: { aria: Pending proposals, tap: Home }
- waitForAnimationToEnd
- runFlow: { file: scrollTo.yaml, env: { element: Repay } }
- runFlow:
    when: { true: "${!amount}" }
    commands: [{ assertNotVisible: "${output.maturity}" }]
- runFlow:
    when: { true: "${amount}" }
    commands:
      - assertVisible: "${output.maturity}"
      - copyTextFrom:
          text: \$[\d,.\xa0]+
          below: Upcoming payments
          rightOf: "${output.maturity}"
      - assertTrue: ${Math.abs(output.debt - Number(maestro.copiedText.replace(/[^\d.]/g, "")) - Number(amount)) < 0.02}
- tapOn: Home
- waitForAnimationToEnd
