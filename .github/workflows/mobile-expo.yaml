name: mobile/expo
on:
  workflow_call:
    inputs:
      profile:
        required: true
        type: string
      build:
        type: boolean
        default: false
    secrets:
      EXPO_TOKEN:
      SENTRY_AUTH_TOKEN:
jobs:
  expo:
    environment:
      name: expo
      url: https://expo.dev/accounts/exactly/projects/exactly
    runs-on: ubuntu-latest
    env:
      CHAIN_ID: ${{ vars.CHAIN_ID }}
      APP_DOMAIN: ${{ vars.APP_DOMAIN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - uses: pnpm/action-setup@v4
        with:
          version: "10.28.1"
          run_install: false
      - uses: actions/setup-node@v4
        with:
          node-version: "^24.13.0"
          cache: pnpm
      - uses: foundry-rs/foundry-toolchain@v1
        with:
          version: v1.5.1
      - uses: expo/expo-github-action@v8
        with:
          packager: pnpm
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      - uses: actions/cache@v4
        with:
          path: .nx/cache
          key: nx-${{ runner.os }}-${{ github.sha }}
          restore-keys: nx-${{ runner.os }}-
      - run: pnpm install --frozen-lockfile
      - run: eas build --profile ${{ inputs.profile }} --platform all --non-interactive --no-wait
        if: inputs.build
      - run: eas update --auto --channel ${{ inputs.profile }} --platform all --non-interactive
      - run: echo "release=$(node -e 'console.log(require(`./src/generated/release`))')" >> $GITHUB_OUTPUT
        id: release
      - uses: actions/upload-artifact@v4
        with: { name: "${{ steps.release.outputs.release }}", path: dist }
      - run: npx sentry-expo-upload-sourcemaps dist
        env:
          SENTRY_ORG: exactly
          SENTRY_PROJECT: exa
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_RELEASE: ${{ steps.release.outputs.release }}
      - id: commits
        if: inputs.profile == 'production'
        run: |
          currentTag="$GITHUB_REF_NAME"
          previousTag=$(git for-each-ref 'refs/tags/@exactly/mobile@*' --sort=-version:refname --format='%(refname:short)' | while read -r tag; do [ "$tag" = "$currentTag" ] && continue; git merge-base --is-ancestor "$tag" "$GITHUB_SHA" && { echo "$tag"; break; }; done)
          if [ -n "$previousTag" ]; then
            echo "mode=manual" >> "$GITHUB_OUTPUT"
            echo "repo=$GITHUB_REPOSITORY" >> "$GITHUB_OUTPUT"
            echo "commit=$GITHUB_SHA" >> "$GITHUB_OUTPUT"
            echo "previous_commit=$(git rev-list -n 1 "$previousTag")" >> "$GITHUB_OUTPUT"
            echo "previous_tag=$previousTag" >> "$GITHUB_OUTPUT"
          else
            echo "mode=auto" >> "$GITHUB_OUTPUT"
          fi
      - uses: getsentry/action-release@v3 # cspell:ignore getsentry
        if: inputs.profile == 'production'
        env:
          SENTRY_ORG: exactly
          SENTRY_PROJECT: exa
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        with:
          environment: ${{ inputs.profile }}
          commit: ${{ steps.commits.outputs.commit }}
          previous_commit: ${{ steps.commits.outputs.previous_commit }}
          repo: ${{ steps.commits.outputs.repo }}
          release: ${{ steps.release.outputs.release }}
          set_commits: ${{ steps.commits.outputs.mode }}
